<!--
Auto-generated by: https://github.com/threlte/threlte/tree/main/packages/gltf
Command: npx @threlte/gltf@2.0.0 track.glb --transform
-->

<script lang="ts">
	import {
		BoxGeometry,
		Group,
		Shape,
		ExtrudeGeometry,
		ShaderMaterial,
		Vector2,
		SphereGeometry
	} from 'three'
	import { T, forwardEventHandlers } from '@threlte/core'
	import { useGltf, useTexture } from '@threlte/extras'
	import { musicVolume } from '$lib/stores'
	import fragmentShader from './shader/fragment.glsl?raw'
	import vertexShader from './shader/vertex.glsl?raw'

	export const ref = new Group()

	const gltf = useGltf('/track-transformed.glb', { useDraco: true })
	const trackLines = useGltf('/track-lines-transformed.glb', { useDraco: true })
	const texture = useTexture('/atlas.png')

	let material: ShaderMaterial

	const component = forwardEventHandlers()

	const mat = new ShaderMaterial({
		uniforms: {
			u_opacity: { value: 1 } // TODO animate it by time by sphears
		},
		vertexShader,
		fragmentShader
	})

	const shape = new Shape([
		new Vector2(24, 24),
		new Vector2(0, 24),
		new Vector2(12, 12),
		new Vector2(24, 0),
		new Vector2(24, 24)
	])

	$: {
		if (material) {
			material.uniforms.gradientWidth.value = $musicVolume / 2 + 0.2
			console.log('hi')
		}
	}

	const extrudeSettings = {
		depth: 2,
		bevelEnabled: true,
		bevelSegments: 2,
		steps: 2,
		bevelSize: 1,
		bevelThickness: 1
	}

	const geometry = new ExtrudeGeometry(shape, extrudeSettings)
</script>

<T is={ref} dispose={false} {...$$restProps} bind:this={$component}>
	{#await gltf then gltf}
		<T.Mesh geometry={gltf.nodes.Plane.geometry} name="track">
			<T.ShaderMaterial
				bind:ref={material}
				{fragmentShader}
				{vertexShader}
				transparent
				uniforms={{ gradientWidth: { value: 0 } }}
				depthTest={true}
				depthWrite={false}
			/>
			<!--{#await texture then t}
				<T.MeshStandardMaterial color="#ffffff" emissive={'#ff00ff'} toneMapped={false}>
					<T is={t} attach="map" flipY={false} />
				</T.MeshStandardMaterial>
			{/await} -->
		</T.Mesh>
	{/await}
	{#await trackLines then t}
		<T.Mesh geometry={t.nodes.Lines.geometry} name="track" position.y={0.001}>
			{#await texture then t}
				<T.MeshStandardMaterial color="#ffffff" toneMapped={false}>
					<T is={t} attach="map" flipY={false} />
				</T.MeshStandardMaterial>
			{/await}
		</T.Mesh>
	{/await}
</T>

<T.Mesh name="booster" visible={false} position={[-27, 7.5, -75]} rotation={[0, 0.1, 0]}>
	<T.BoxGeometry args={[6, 1, 1]} />
	<T.MeshStandardMaterial />
</T.Mesh>

<T.Group position={[-29.9, 7.9, -80]} scale={[0.09, 0.3, 0.09]} rotation={[1.57, 0, -0.1]}>
	<T.Mesh name="chevron" rotation.z={0.785}>
		<T is={geometry} />
		<T.MeshBasicMaterial wireframe />
	</T.Mesh>
	<T.Mesh name="chevron" rotation.z={0.785} position.x={40}>
		<T is={geometry} />
		<T.MeshBasicMaterial wireframe />
	</T.Mesh>
</T.Group>

<T.Mesh name="booster" visible={false} position={[-5, -2.5, -3.4]} rotation={[0, 1.57, 0]}>
	<T.BoxGeometry args={[7, 1, 1]} />
	<T.MeshStandardMaterial />
</T.Mesh>
<T.Group position={[0, -2.2, -5.3]} scale={[0.09, 0.3, 0.09]} rotation={[1.57, 0, 1.57]}>
	<T.Mesh name="chevron" rotation.z={0.785}>
		<T is={geometry} />
		<T.MeshBasicMaterial wireframe />
	</T.Mesh>
	<T.Mesh name="chevron" rotation.z={0.785} position.x={40}>
		<T is={geometry} />
		<T.MeshBasicMaterial wireframe />
	</T.Mesh>
</T.Group>
